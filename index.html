<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aplikasi Nilai Raport - Simpel Dark</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    * { box-sizing: border-box; }
    body { font-family: 'Poppins', sans-serif; background: #0d0d0d; margin: 0; color: #e6e6e6; }
    #splash { position: fixed; inset: 0; background: #000; display: flex; justify-content: center; align-items: center; font-size: 22px; transition: .7s; z-index: 9999; }
    .fade-out { opacity: 0; pointer-events: none; }
    header { text-align: center; padding: 0 0 0 40px; background: #101010; border-bottom: 1px solid #222; font-size: 18px; font-weight: 600; position: relative; display: flex; align-items: center; justify-content: center; height: 60px; }
    .menu-btn { position: absolute; left: 15px; background: transparent; border: none; cursor: pointer; padding: 8px; width: auto; margin: 0; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    .menu-btn:hover { background: rgba(255,255,255,0.1); border-radius: 6px; }
    .menu-btn div { width: 26px; height: 2.5px; background: #fff; margin: 4px 0; border-radius: 2px; transition: .3s; }
    .sidebar { position: fixed; left: -300px; top: 0; width: 300px; height: 100vh; background: #0a0a0a; border-right: 1px solid #222; transition: .3s; z-index: 9998; padding-top: 70px; box-shadow: 2px 0 10px rgba(0,0,0,0.5); overflow-y: auto; }
    .sidebar.active { left: 0; }
    .sidebar button { width: calc(100% - 30px); margin: 8px 15px; display: block; padding: 16px 18px; border-radius: 8px; background: #1a1a1a; border: 1px solid #333; color: #f2f2f2; cursor: pointer; transition: .2s; text-align: left; font-size: 15px; }
    .sidebar button:hover { background: #222; border-color: #444; transform: translateX(5px); }
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 9997; display: none; }
    .overlay.active { display: block; }
    .container { width: 92%; max-width: 550px; margin: 20px auto 30px; background: #131313; padding: 22px; border-radius: 12px; border: 1px solid #222; box-shadow: 0 4px 12px rgba(0,0,0,0.3); min-height: calc(100vh - 140px); display: flex; flex-direction: column; justify-content: center; }
    h2 { margin-top: 0; margin-bottom: 18px; font-size: 19px; border-bottom: 2px solid #222; padding-bottom: 10px; }
    label { display: block; margin-bottom: 6px; margin-top: 10px; font-size: 14px; font-weight: 500; color: #ccc; }
    input, select { width: 100%; padding: 11px; margin-bottom: 8px; border-radius: 8px; border: 1px solid #333; background: #1a1a1a; color: #eee; font-size: 14px; transition: .2s; }
    input:focus, select:focus { outline: none; border-color: #555; background: #222; }
    input.error { border-color: #ff4d4d; background: #2b0000; color: #fff; }
    button { width: 100%; padding: 11px; margin-top: 8px; border-radius: 8px; border: none; font-size: 15px; font-weight: 600; cursor: pointer; transition: .2s; }
    .btn-white { background: #fff; color: #000; }
    .btn-white:hover { background: #e6e6e6; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(255,255,255,0.2); }
    .btn-black { background: #000; border: 1px solid #555; color: #fff; }
    .btn-black:hover { background: #222; }
    .btn-small { width: auto; padding: 8px 16px; font-size: 13px; margin-top: 12px; margin-bottom: 12px; display: inline-block; }
    .hidden { display: none; }
    .card { background: #1b1b1b; border: 1px solid #333; padding: 14px; border-radius: 10px; margin-bottom: 12px; transition: .2s; }
    .card:hover { border-color: #444; background: #1f1f1f; }
    .mapelItem { margin-bottom: 12px; background: #181818; padding: 14px; border-radius: 8px; border: 1px solid #2a2a2a; }
    .mapelItem label { margin-top: 0; margin-bottom: 8px; }
    .mapelItem input { margin-bottom: 0; }
    .error-msg { color: #ff4d4d; font-size: 13px; margin-top: -6px; margin-bottom: 6px; display: none; }
    #hasilSmt { margin-top: 18px; padding: 14px; background: #1a1a1a; border-radius: 8px; border-left: 4px solid #4CAF50; }
    #rekapIsi p { margin: 6px 0; font-size: 15px; }
    #rekapIsi hr { margin: 12px 0; border: none; border-top: 1px solid #333; }
    #rekapIsi h3 { margin-top: 8px; color: #4CAF50; }
    canvas { max-width: 100%; margin-top: 18px; }
</style>
</head>

<body>

<div id="splash">Loading...</div>

<div class="overlay" id="overlay" onclick="toggleMenu()"></div>

<header>
    <button class="menu-btn" onclick="toggleMenu()">
        <div></div>
        <div></div>
        <div></div>
    </button>
    Website Penghitungan Nilai Raport
</header>

<div class="sidebar" id="sidebar">
    <button onclick="navigateTo('loginPage')">üìù Login</button>
    <button onclick="navigateTo('nilaiPage')">üßÆ Penghitungan</button>
    <button onclick="navigateTo('savedPage')">üíæ Data Tersimpan</button>
</div>

<!-- LOGIN -->
<div class="container" id="loginPage">
    <h2>Login Siswa</h2>
    <label>Nama Siswa</label>
    <input type="text" id="nama">
    <div class="error-msg" id="errNama">Nama wajib diisi!</div>

    <label>Kelas</label>
    <input type="text" id="kelas">
    <div class="error-msg" id="errKelas">Kelas wajib diisi!</div>

    <button class="btn-white" onclick="masuk()">Masuk</button>
</div>

<!-- NILAI -->
<div class="container hidden" id="nilaiPage">
    <h2>Hitung Nilai Semester</h2>

    <label>Pilih Semester</label>
    <select id="semester" onchange="resetForm()">
        <option value="1">Semester 1</option>
        <option value="2">Semester 2</option>
        <option value="3">Semester 3</option>
        <option value="4">Semester 4</option>
        <option value="5">Semester 5</option>
        <option value="6">Semester 6</option>
    </select>

    <button class="btn-small btn-white" onclick="tambahMapel()">+ Tambah Mapel</button>

    <div id="mapelList"></div>

    <button class="btn-black" onclick="simpanSemester()">Simpan Semester</button>

    <div id="hasilSmt"></div>

    <div id="semuaSemester" style="margin-top: 20px;"></div>

    <div id="rekapBtn" class="hidden">
        <button class="btn-white" onclick="rekapAkhir()">Lihat Rekap Nilai Akhir</button>
    </div>
</div>

<!-- REKAP -->
<div class="container hidden" id="rekapPage">
    <h2>Rekap Nilai Akhir</h2>

    <div id="rekapIsi"></div>

    <canvas id="chartNilai" style="margin-top:20px;"></canvas>

    <button class="btn-white" onclick="saveFinalData()">Simpan Hasil Akhir</button>
</div>

<!-- DATA TERSIMPAN -->
<div class="container hidden" id="savedPage">
    <h2>Data Hasil Tersimpan</h2>
    <div id="savedList"></div>
</div>

<script>
window.onload = () => { setTimeout(() => splash.classList.add("fade-out"), 800); };

let dataSemester = {1:null,2:null,3:null,4:null,5:null,6:null};
let mapelCount = 0;
let chart = null;

function toggleMenu() {
    sidebar.classList.toggle("active");
    overlay.classList.toggle("active");
}

function navigateTo(page) {
    showPage(page);
    toggleMenu();
}

function showPage(page) {
    document.querySelectorAll(".container").forEach(c => c.classList.add("hidden"));
    document.getElementById(page).classList.remove("hidden");
    if (page === "savedPage") loadSaved();
    if (page === "nilaiPage") tampilkanSemuaSemester();
}

// ================= LOGIN =================
function masuk() {
    nama.classList.remove("error");
    kelas.classList.remove("error");
    document.getElementById("errNama").style.display = "none";
    document.getElementById("errKelas").style.display = "none";

    const namaVal = nama.value.trim();
    const kelasVal = kelas.value.trim();
    let valid = true;

    if (namaVal === "") { nama.classList.add("error"); document.getElementById("errNama").style.display = "block"; valid = false; }
    if (kelasVal === "") { kelas.classList.add("error"); document.getElementById("errKelas").style.display = "block"; valid = false; }
    if (!valid) return;

    showPage("nilaiPage");
}

// ================== MAPEL =================
function tambahMapel() {
    mapelCount++;
    let div = document.createElement("div");
    div.className = "mapelItem";
    div.innerHTML = `
        <label>Mapel ${mapelCount}</label>
        <div style="display:flex; gap:10px;">
            <input type="number" class="nilaiMapel" style="flex:1;">
            <button class="btn-small btn-black" onclick="hapusMapel(this)">Hapus</button>
        </div>`;
    mapelList.appendChild(div);
}

function hapusMapel(btn) { btn.parentElement.parentElement.remove(); }
function resetForm() { mapelList.innerHTML = ""; mapelCount = 0; hasilSmt.innerHTML = ""; }

// ====================== SIMPAN SEMESTER ======================
function simpanSemester() {
    const inputs = document.querySelectorAll(".nilaiMapel");
    if (inputs.length === 0) {
        alert("Tambah minimal 1 mapel!");
        return;
    }

    let total = 0;
    for (let i = 0; i < inputs.length; i++) {
        const val = parseFloat(inputs[i].value);
        if (isNaN(val)) {
            alert(`Nilai Mapel ${i + 1} harus diisi dengan angka!`);
            return;
        }
        total += val;
    }

    const rata = total / inputs.length;
    const smt = semester.value;
    dataSemester[smt] = Number(rata.toFixed(2));

    hasilSmt.innerHTML = `‚úî Rata-rata Semester ${smt}: <b>${rata.toFixed(2)}</b>`;
    
    tampilkanSemuaSemester();

    // Tombol rekap muncul jika semester 1-3 sudah diisi dan sudah mulai semester 4 atau lebih
    if (dataSemester[1] && dataSemester[2] && dataSemester[3]) {
        if (smt >= 4 || dataSemester[4] || dataSemester[5] || dataSemester[6]) {
            rekapBtn.classList.remove("hidden");
        }
    }
}

// ====================== TAMPILKAN SEMUA SEMESTER ======================
function tampilkanSemuaSemester() {
    let html = '<div style="background: #1a1a1a; padding: 15px; border-radius: 8px; border: 1px solid #2a2a2a;">';
    html += '<h3 style="margin-top: 0; margin-bottom: 12px; font-size: 16px; border-bottom: 1px solid #333; padding-bottom: 8px;">üìä Nilai Semester</h3>';
    
    for (let i = 1; i <= 6; i++) {
        if (dataSemester[i] !== null) {
            html += `<p style="margin: 6px 0; font-size: 14px;">Semester ${i}: <b>${dataSemester[i].toFixed(2)}</b></p>`;
        }
    }
    
    html += '</div>';
    semuaSemester.innerHTML = html;
}

// ====================== REKAP ======================
function rekapAkhir() {
    showPage("rekapPage");

    let total = 0;
    let hitung = 0;
    let html = '';

    for (let i = 1; i <= 6; i++) {
        if (dataSemester[i] !== null) {
            html += `<p>Semester ${i}: <b>${dataSemester[i].toFixed(2)}</b></p>`;
            total += dataSemester[i];
            hitung++;
        }
    }

    const totalAkhir = hitung > 0 ? (total / hitung).toFixed(2) : 0;

    html += '<hr style="border-color:#333;">';
    html += `<h3>Total Nilai Akhir: <b>${totalAkhir}</b></h3>`;

    rekapIsi.innerHTML = html;

    buatGrafik();
}

// ====================== BUAT GRAFIK ======================
function buatGrafik() {
    const ctx = document.getElementById("chartNilai").getContext("2d");
    if (chart) chart.destroy();

    let labels = [];
    let data = [];

    for (let i = 1; i <= 6; i++) {
        if (dataSemester[i] !== null) {
            labels.push("Semester " + i);
            data.push(dataSemester[i]);
        }
    }

    chart = new Chart(ctx, {
        type: "line",
        data: {
            labels: labels,
            datasets: [{
                label: "Nilai Rata-rata",
                data: data,
                borderColor: "#4CAF50",
                backgroundColor: "rgba(76, 175, 80, 0.3)",
                borderWidth: 3,
                tension: 0.3,
                pointRadius: 5,
                pointBackgroundColor: "#fff",
                pointBorderColor: "#4CAF50"
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { labels: { color: "#eee" } } },
            scales: {
                x: { ticks: { color: "#ccc" }, grid: { color: "#333" } },
                y: { ticks: { color: "#ccc" }, grid: { color: "#333" } }
            }
        }
    });
}

// ====================== SIMPAN FINAL & GOOGLE SHEETS ======================
function saveFinalData() {
    if (!dataSemester[1] || !dataSemester[2] || !dataSemester[3]) {
        alert("Semester 1-3 harus diisi dahulu!");
        return;
    }

    const totalAkhir = ((dataSemester[1] + dataSemester[2] + (dataSemester[3]||0) + (dataSemester[4]||0) + (dataSemester[5]||0) + (dataSemester[6]||0)) / 
                        [dataSemester[1],dataSemester[2],dataSemester[3],dataSemester[4],dataSemester[5],dataSemester[6]].filter(v=>v!==null).length).toFixed(2);

    const finalData = {
        nama: nama.value.trim(),
        kelas: kelas.value.trim(),
        tanggal: new Date().toLocaleString(),
        data: { ...dataSemester },
        total: totalAkhir
    };

    let saved = JSON.parse(localStorage.getItem("raportData") || "[]");
    saved.push(finalData);
    localStorage.setItem("raportData", JSON.stringify(saved));

    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyLVdwv40Un9g7T8EMWRt-GZMLePyGuPA553xwZxHCJ73aDQ2IPprVP8V5xHbBzkhqXgA/exec";

    fetch(WEB_APP_URL, {
        method: "POST",
        body: JSON.stringify(finalData),
        headers: { "Content-Type": "application/json" }
    })
    .then(res => res.json())
    .then(res => {
        if (res.status === 'success') {
            alert("Data berhasil disimpan di perangkat & Google Sheets!");
        } else {
            alert("Gagal menyimpan ke Google Sheets: " + (res.message || "Unknown error"));
        }
    })
    .catch(err => {
        console.error("Fetch error:", err);
        alert("Terjadi error saat mengirim ke Google Sheets. Cek console untuk detail.");
    });
}

// ====================== LOAD DATA LOKAL ======================
function loadSaved() {
    const saved = JSON.parse(localStorage.getItem("raportData") || "[]");
    savedList.innerHTML = "";
    if (saved.length === 0) { savedList.innerHTML = "<p>Belum ada data tersimpan.</p>"; return; }
    saved.forEach(d => {
        const div = document.createElement("div");
        div.className = "card";
        div.innerHTML = `<b>${d.nama} ‚Äî Kelas ${d.kelas}</b><br><small>${d.tanggal}</small><p>Total Nilai Akhir: <b>${d.total}</b></p>`;
        savedList.appendChild(div);
    });
}
</script>

</body>
</html>
